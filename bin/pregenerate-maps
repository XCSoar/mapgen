#!/usr/bin/python

import os, sys, re
import shutil
import json

app_dir = os.path.abspath(__file__ + '/../..')
sys.path.append(os.path.join(app_dir, 'lib'))

from xcsoar.mapgen.generator import Generator
from xcsoar.mapgen.georect import GeoRect
from xcsoar.mapgen.downloader import Downloader
from xcsoar.mapgen.util import slurp

def main():
    dir_data = os.path.join(app_dir, 'data')
    dir_temp = '/tmp/mapgen-{}'.format(os.getpid())
    config = Downloader(dir_data).retrieve('maps.config.js')
    config = re.sub(r'var\s+MAPS\s+=\s+|;', '', slurp(config))
    maps = json.loads(config)
    try:
        for name in sorted(maps.keys()):
            output_file = name + '.xcm'
            bounds = maps[name]
            left   = bounds[0]
            bottom = bounds[1]
            right  = bounds[2]
            top    = bounds[3]
            generator = Generator(dir_data=dir_data, dir_temp=dir_temp)
            generator.set_bounds(GeoRect(left, right, top, bottom))
            generator.add_information_file(output_file)
            generator.add_topology()
            generator.add_terrain(9.0)
            generator.create(output_file)
            generator.cleanup()
    finally:
        if os.path.exists(dir_temp): shutil.rmtree(dir_temp)

if __name__ == '__main__':
    main()
